name: Release

on:
  workflow_dispatch: {}

env:
  GO_VERSION: "1.25.5"
  WAILS_VERSION: "v2.11.0"
  APP_NAME: "game-of-life"
  APP_DIR: "apps/game-of-life"
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  build-macos:
    name: Build macOS ARM
    runs-on: macos-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - uses: oven-sh/setup-bun@v2

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Build frontend
        working-directory: ${{ env.APP_DIR }}/frontend
        run: bun install && bun run build

      - name: Build Wails app
        working-directory: ${{ env.APP_DIR }}
        run: wails build -platform darwin/arm64 -clean

      - name: Ad-hoc sign binary
        working-directory: ${{ env.APP_DIR }}/build/bin
        run: codesign -s - --force --deep ${{ env.APP_NAME }}.app

      - name: Package as DMG
        working-directory: ${{ env.APP_DIR }}/build/bin
        run: hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder ${{ env.APP_NAME }}.app -ov -format UDZO ${{ env.APP_NAME }}-darwin-arm64.dmg

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-darwin-arm64
          path: ${{ env.APP_DIR }}/build/bin/${{ env.APP_NAME }}-darwin-arm64.dmg

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - uses: oven-sh/setup-bun@v2

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Build frontend
        working-directory: ${{ env.APP_DIR }}/frontend
        run: bun install && bun run build

      - name: Build Wails app
        working-directory: ${{ env.APP_DIR }}
        run: wails build -platform windows/amd64 -clean

      - name: Package binary
        shell: pwsh
        run: |
          Compress-Archive -Path ${{ env.APP_DIR }}/build/bin/${{ env.APP_NAME }}.exe -DestinationPath ${{ env.APP_NAME }}-windows-amd64.zip

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-amd64
          path: ${{ env.APP_NAME }}-windows-amd64.zip

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build-macos, build-windows]
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v0.0.0-test
          name: "Test Release"
          files: |
            artifacts/${{ env.APP_NAME }}-darwin-arm64.dmg
            artifacts/${{ env.APP_NAME }}-windows-amd64.zip
